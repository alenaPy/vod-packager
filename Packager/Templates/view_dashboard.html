{% extends "base_views.html" %}

{% block title %}Dashboard{% endblock %}

{% block content %}

<link rel="stylesheet" href="/css/dashboard.css" />

{% for package_group in packages_groups %}
<span class="dashboardTitle">Package group: {{package_group.name}}</span>

<table class="tblDashboard">
	<tbody>
		<tr>
			<th class="thUpperLeft"></th>
			{% for customer in customers %}
			<th style="border: 1px solid white;"><div class="verticalText">{{customer.name}}</div></th>
			{% endfor %}
		</tr>
		{% for item in matriz %}
		<tr id="item_{{item.0.0}}">
			<td class="tdItemTitle">{{item.0.1}}</td>
			{% for customer in customers %}
			<td id="customer_{{customer.id}}" class="tdPackageStatus" style="text-align:right;">
				<span class="pkgstatus_"></span>
			</td>
			{% endfor %}
		</tr>
		{% endfor %}
	</tbody>
</table>
{% endfor %}
<!-- VIEW'S ICONOGRAPHY -->
<table id="tblIconography">
	<tr>
		<td class="tdIconographyIcon" title="Package under process">
			<img src="/images/icons/hourglass.png"></td><td class="tdIconographyDesc">Queued
		</td>
		<td class="tdIconographyIcon" title="Package ready for download">
			<img src="/images/icons/tick.png"></td><td class="tdIconographyDesc">Packaged
		</td>
		<td class="tdIconographyIcon" title="Error creating package">
			<img src="/images/icons/exclamation.png"></td><td class="tdIconographyDesc">Error
		</td>
		<td width="99%"></td>
	<tr>
</table>

<script>
var json_string = "{\"items\": [{% for item in matriz %}{\"item\":{{item.0.0}}, \"pkgs\":[{% for pkg in item.1 %}{\"pkg_id\":{{pkg.0}}, \"customer_id\":{{pkg.1}}, \"pkg_status\":\"{{pkg.2}}\"},{% endfor %}{\"pkg_id\":0, \"customer_id\":0, \"pkg_status\":\"\"}]},{% endfor %}{\"item\":0, \"pkgs\":[]}]}";

$(document).ready(function() {

	var json_object = JSON.parse(json_string);
	$.each(json_object.items, function(indexa, value) {
		if (json_object.items[indexa].item != 0) {
			var item_id = json_object.items[indexa].item;
			var tr_tag_id = "item_" + item_id.toString();
			var trItem = $("#"+tr_tag_id);
			var tds = trItem.children("td");
			$.each(tds, function(indexb, value) {
				if (tds[indexb].id != "") {
					var td_tag_id = tds[indexb].id;
					var customer_id = parseInt(rightstr(td_tag_id, "_"));
					var pkg_status = findPackageStatus(json_object, indexa, customer_id);
					if (pkg_status != "ZZZ") {
						var td = $("#"+tr_tag_id).children("#"+td_tag_id);
						var span = td.children("span");
						span.attr("class", "pkgstatus_"+pkg_status);
					}
				}
			});
			
		}
	});

});

function findPackageStatus(json_object, item_id, customer_id) {
	var output = "ZZZ";
	$.each(json_object.items[item_id].pkgs, function(indexc, value) {
		if (json_object.items[item_id].pkgs[indexc].customer_id == customer_id) {
			output = json_object.items[item_id].pkgs[indexc].pkg_status;
		}
	});
	return output;
}

function rightstr(s, c) {
	L = s.lastIndexOf(c);
	L = L + 1;
	return s.slice(L);
}
</script>

{% endblock %}

{% block action_bar %}

{% if packages_groups.has_previous %}
<a href="?page={{ packages_groups.previous_page_number }}" class="bttn prev">Previous</a>
{% endif %}
<a href="#" onclick="javascript:actionRefreshView();" class="bttn icon refresh">Refresh<a>
{% if packages_groups.has_next %}
<a href="?page={{ packages_groups.next_page_number }}" class="bttn next">Next</a>
{% endif %}

{% endblock %}